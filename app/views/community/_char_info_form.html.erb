<%
  if (params[:text].present?)
    text = params[:text].to_s
    chars = text.to_s.chars
  elsif params[:scripts].present?
    chars = []
    text = ''
    params[:scripts].split(',').each do |script|
      if scripts.keys.include?(script.to_sym)
        ayahs = Verse.order('id ASC').pluck(script)
        text ||= ayahs[0]
        params[:script] ||= script
        chars += ayahs.join(' ').chars
      end
    end

  elsif params[:script].present? && scripts.keys.include?(params[:script].strip.to_sym)
    ayahs = Verse.order('id ASC').pluck(params[:script].strip)
    text = ayahs[0]
    chars = ayahs.join(' ').chars
  else
    chars = []
  end

  uniq_chars = chars.uniq.sort.compact_blank
  char_set = uniq_chars.sort.join(' ').strip
%>

<%= render 'tools/header',
           name: "Text and Font Compatibility Checker",
           key: 'char'
%>

<div class="page-wrapper tw-container tw-max-w-7xl tw-mx-auto tw-px-4" data-controller="chars-info">
  <div class="page-section">
    <div class="tw-flex tw-flex-wrap tw-gap-4">
      <div class="tw-w-full">
        <%= form_with url: chars_info_path, method: "get" do |form| %>
          <div class="tw-mb-4">
            <%= form.label :text, 'Enter the text', class: 'tw-font-medium tw-mb-2 tw-block' %>
            <%= form.text_area :text, 
                value: params[:text], 
                class: "tw-w-full tw-px-3 tw-py-2 tw-border tw-border-gray-300 tw-rounded-md tw-focus:tw-outline-none tw-focus:tw-ring-2 tw-focus:tw-ring-blue-500 tw-focus:tw-border-transparent text",
                data: { chars_info_target: "input" },
                placeholder: "بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ" %>
            <div class="tw-text-sm tw-text-gray-600 tw-mt-2">
              Enter the text to analyze its Unicode characters or preview it across all available fonts
            </div>
            <% if params[:name].present? %>
              <div class="help-block">
                <%= params[:name] %>
              </div>
            <% end %>
          </div>

          <div class="tw-mb-4">
            <%= form.label :script, 'Select script' %>
            <%
              scripts_options = scripts.map do |key, name|
                [name, key]
              end
            %>
            <%= form.select :script, options_for_select(scripts_options, params[:script]), { include_blank: 'Select ' }, class: "tw-w-full tw-px-3 tw-py-2 tw-border tw-border-gray-300 tw-rounded-md tw-focus:tw-outline-none tw-focus:tw-ring-2 tw-focus:tw-ring-blue-500 tw-focus:tw-border-transparent" %>
          </div>

          <div class="tw-mb-4 tw-flex tw-gap-3 tw-mt-2 tw-flex-wrap">
            <%= form.submit "Analyze Unicode", class: "tw-px-4 tw-py-2 tw-text-sm tw-font-medium tw-bg-green-600 hover:tw-bg-green-700 tw-text-white tw-rounded tw-transition-colors" %>
            <button 
              type="button"
              data-action="click->chars-info#showPreview"
              class="tw-px-4 tw-py-2 tw-text-sm tw-font-medium tw-bg-blue-600 hover:tw-bg-blue-700 tw-text-white tw-rounded tw-transition-colors"
            >
              Preview in All Fonts
            </button>
          </div>
        <% end %>
      </div>
    </div>

    <%= render 'char_font_options' %>

    <div data-chars-info-target="output" class="tw-hidden tw-mb-8">
      <div class="tw-bg-gradient-to-r tw-from-blue-50 tw-to-indigo-50 tw-rounded-xl tw-p-6 tw-border tw-border-blue-200 tw-shadow-sm">
        <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
          <h3 class="tw-text-2xl tw-font-bold tw-text-gray-800 tw-flex tw-items-center tw-gap-2">
            <svg class="tw-w-6 tw-h-6 tw-text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
            Font Compatibility Preview
          </h3>
          <button 
            data-action="click->chars-info#hidePreview"
            class="tw-text-gray-500 hover:tw-text-gray-700 tw-p-1 tw-rounded-full hover:tw-bg-white tw-transition"
            title="Close preview"
          >
            <svg class="tw-w-6 tw-h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <p class="tw-text-gray-600 tw-mb-6">
          Viewing your text across <%= all_quran_fonts.size %> available Quranic fonts. Check compatibility and rendering quality for each font.
        </p>
        
        <div class="tw-space-y-3">
          <% all_quran_fonts.each do |font_name, font_class| %>
            <div class="tw-bg-white tw-rounded-lg tw-p-5 tw-border tw-border-gray-200 tw-shadow-sm hover:tw-shadow-md tw-transition-shadow">
              <div class="tw-flex tw-items-center tw-justify-between tw-mb-3">
                <div class="tw-text-sm tw-font-semibold tw-text-gray-700 tw-px-3 tw-py-1 tw-bg-gray-100 tw-rounded-full">
                  <%= font_name %>
                </div>
              </div>

              <div class="<%= font_class %> tw-text-3xl tw-leading-relaxed tw-py-2 tw-px-2 tw-bg-gray-50 tw-rounded preview-text"
                   data-chars-info-target="preview"
                   data-font-class="<%= font_class %>"
                   dir="rtl">
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="section">
      <% if uniq_chars.present? %>
        <div class="char">
          <%= text %>
        </div>

        <div>
          Total Chars: <%= chars.length %> <br/>
          Uniq Chars: <%= uniq_chars.length %>
        </div>

        <div data-text="<%= char_set -%>"
             title="Copy <%= char_set %>"
             data-controller="tooltip copy-to-clipboard"
             class="char"
        >
          <%= char_set %>
        </div>
      <% end %>

      <div class="tools-table-overflow">   
      <table class="tw-w-full hover:tw-bg-gray-50">
        <thead class="tw-sticky tw-top-0 tw-z-10 tw-bg-white tw-border-b tw-border-gray-300">
        <tr class="sticky">
          <th>#</th>
          <th style="width: 100px">Name</th>
          <th>Char</th>
          <th>Count</th>
          <th>Decimal</th>
          <th class="tw-truncate tw-whitespace-nowrap">HTML entity</th>
          <th>Decomposition</th>
          <th>Hex</th>
        </tr>
        </thead>
        <tbody>
        <% uniq_chars.each_with_index do |char, i| %>
          <tr>
            <%
              hex = char.ord.to_s(16).rjust(4, '0')
              decimal = char.ord
              decomposition = char.unicode_normalize(:nfd)
            %>
            <td><%= i + 1 %></td>
            <td>
              <% if params[:script].present? %>
                <%= link_to Unicode::Name.of(char) || 'UNDEF', chars_info_path(char: char, script: params[:script]), target: '_blank' %>
              <% else %>
                <%= Unicode::Name.of(char) %>
              <% end %>
            </td>
            <td data-text="<%= char -%>"
                title="Copy <%= char %>"
                data-controller="tooltip copy-to-clipboard"
                class="char"
            >
              <%= char %>
            </td>
            <td><%= chars.count char %></td>
            <td><%= decimal %></td>
            <td><%= "&##{decimal};" %></td>
            <td>
              <% if decomposition.size > 1 %>
                <span class="char">
                (<%= decomposition.chars.join(" - ") %>)
                </span>

                <span class="tw-ml-2"
                      data-text="<%= decomposition -%>"
                      title="Copy <%= decomposition %>"
                      data-controller="tooltip copy-to-clipboard"
                      class="char"
                >
                  Copy <%= decomposition %>
                </span>
              <% end %>
            </td>
            <td><%= link_to hex, "https://www.compart.com/en/unicode/U+#{hex}", target: '_blank' %></td>
          </tr>
        <% end %>
        </tbody>
      </table>
      </div>
    </div>
  </div>
</div>
