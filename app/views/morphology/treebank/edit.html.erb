<%= render 'tools/header',
           name: 'Morphology Treebank',
           key: 'ayah_dependency_graph',
           help: false
%>

<div class="page-wrapper container-lg">
  <div class="page-section">
    <div class="tw-w-full">
      <div class="tw-bg-white tw-border tw-border-gray-200 tw-rounded-lg tw-shadow-sm tw-mb-4">
        <div class="tw-flex tw-justify-between tw-items-center tw-bg-gray-50 tw-p-3 tw-border-b tw-border-gray-200">
          <div class="tw-flex tw-items-center tw-gap-3">
            <strong>Verse:</strong><%= @graph.verse_key %> (Graph <%= @graph.graph_number %>)
          </div>
          <h3 class="tw-text-xl tw-mb-0">Edit Syntax Graph</h3>
          <div>
            <%= link_to 'Back to View', morphology_treebank_index_path(chapter_number: @chapter_number, verse_number: @verse_number, graph_number: @graph_number), class: 'tw-px-3 tw-py-1.5 tw-bg-black tw-text-white tw-rounded tw-text-sm hover:tw-bg-black-700' %>
          </div>
        </div>

        <div class="tw-p-4">
          <% if flash[:alert] %>
            <div class="tw-bg-red-50 tw-border tw-border-red-200 tw-text-red-800 tw-px-4 tw-py-3 tw-rounded tw-mb-4">
              <%= flash[:alert] %>
            </div>
          <% end %>
          
          <% if flash[:notice] %>
            <div class="tw-bg-green-50 tw-border tw-border-green-200 tw-text-green-800 tw-px-4 tw-py-3 tw-rounded tw-mb-4">
              <%= flash[:notice] %>
            </div>
          <% end %>

          <%= hidden_field_tag :graph_id, @graph.id, id: 'graph_id' %>

          <div class="tw-flex tw-flex-wrap">
            <div class="tw-w-full lg:tw-w-10/12 tw-p-0">
              <%= render 'nodes_section', presenter: @presenter, graph_id: @graph.id %>
              <%= render 'phrase_nodes_section', presenter: @presenter, graph_id: @graph.id %>
              <%= render 'edges_section', presenter: @presenter, graph_id: @graph.id %>
            </div>

            <div class="lg:tw-col-span-2">
              <div class="tw-sticky tw-top-[70vh]">
                <div class="tw-bg-white tw-border tw-border-gray-200 tw-rounded-lg tw-shadow-sm" id="graph_preview_panel">
                  <div class="tw-flex tw-justify-between tw-items-center tw-py-2 tw-bg-gray-50 tw-px-3 tw-border-b tw-border-gray-200">
                    <h2 class="tw-text-lg tw-font-semibold tw-m-0">Preview</h2>
                    <div>
                      <button type="button" 
                              class="tw-px-2 tw-py-1 tw-text-sm tw-rounded tw-font-medium tw-transition-colors tw-border tw-border-gray-600 tw-text-gray-600 hover:tw-bg-gray-600 hover:tw-text-white tw-me-1"
                              onclick="window.dispatchEvent(new CustomEvent('refresh-graph-preview'));"
                              title="Refresh">
                        <i class="fa fa-refresh"></i>
                      </button>
                      <button type="button" 
                              class="tw-px-2 tw-py-1 tw-text-sm tw-rounded tw-font-medium tw-transition-colors tw-border tw-border-blue-600 tw-text-blue-600 hover:tw-bg-blue-600 hover:tw-text-white"
                              onclick="document.getElementById('graphPreviewModal').classList.remove('tw-hidden'); document.body.style.overflow = 'hidden';"
                              title="Expand">
                        <i class="fa fa-expand"></i>
                      </button>
                    </div>
                  </div>
                  <div class="tw-p-2 tw-bg-white">
                    <div class="syntax-graph-container rounded bg-light tw-min-h-[150px] tw-max-h-[50vh] tw-overflow-auto"
                         data-controller="syntax-graph"
                         data-syntax-graph-url-value="<%= syntax_graph_morphology_treebank_index_path(chapter_number: @chapter_number, verse_number: @verse_number, graph_number: @graph_number) %>"
                         id="graph_preview_container">
                      <div data-syntax-graph-target="container" class="tw-p-3 tw-text-center text-muted">Loading syntax graph...</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="tw-fixed tw-inset-0 tw-z-50 tw-overflow-y-auto tw-hidden" id="graphPreviewModal" tabindex="-1" aria-labelledby="graphPreviewModalLabel" aria-hidden="true">
  <div class="tw-flex tw-min-h-full tw-items-center tw-justify-center tw-p-4">
    <div class="tw-relative tw-bg-white tw-rounded-lg tw-shadow-xl tw-w-full tw-max-w-6xl">
      <div class="tw-flex tw-items-center tw-justify-between tw-p-4 tw-border-b">
        <h5 class="tw-text-lg tw-font-semibold" id="graphPreviewModalLabel">
          Graph Preview - <%= @graph.verse_key %> (Graph <%= @graph.graph_number %>)
        </h5>
        <div class="tw-flex tw-items-center tw-gap-2">
          <button type="button" 
                  class="tw-px-3 tw-py-1.5 tw-text-xs tw-font-medium tw-bg-transparent tw-text-gray-600 tw-border tw-border-gray-600 hover:tw-bg-gray-600 hover:tw-text-white tw-rounded tw-transition-colors"
                  onclick="window.dispatchEvent(new CustomEvent('refresh-graph-preview'));">
            <i class="fa fa-refresh"></i> Refresh
          </button>
          <button type="button" class="tw-absolute tw-top-2 tw-right-2 tw-text-gray-400 hover:tw-text-gray-900 tw-bg-transparent hover:tw-bg-gray-200 tw-rounded-lg tw-p-1.5 tw-inline-flex tw-items-center tw-justify-center tw-transition-colors" data-action="click->ajax-modal#hide" aria-label="Close">
            <svg class="tw-w-5 tw-h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="tw-p-4">
        <div class="syntax-graph-container bg-light tw-min-h-[500px] tw-max-h-[80vh] tw-overflow-auto"
             data-controller="syntax-graph"
             data-syntax-graph-url-value="<%= syntax_graph_morphology_treebank_index_path(chapter_number: @chapter_number, verse_number: @verse_number, graph_number: @graph_number) %>"
             id="graph_preview_modal_container">
          <div data-syntax-graph-target="container" class="tw-p-3">Loading syntax graph...</div>
        </div>
      </div>
    </div>
  </div>
</div>
