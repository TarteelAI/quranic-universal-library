<%= render 'tools/header',
           name: 'Mutashabihat ul Quran',
           title: 'Mutashabihat Phrase Builder',
           key: 'mutashabihat',
           actions: [link_to('Back', morphology_phrases_path, class: 'tw-px-4 tw-py-2 tw-rounded tw-font-medium tw-transition-colors tw-bg-cyan-600 hover:tw-bg-cyan-700 tw-text-white')]
%>

<div class="page-wrapper tw-container tw-max-w-7xl tw-mx-auto tw-px-4" style="position: relative">
  <div data-controller="mutashabihat-builder" class="mutashabihat">
    <%= form_with url: new_morphology_phrase_path, method: :get do |f| %>
      <%= f.hidden_field :phrase_id, value: @phrase&.id %>
      <div class="page-section tw-tw-mt-4">
        <figure class="highlight tw-tw-mt-4 tw-border tw-border-gray-300 tw-my-2 tw-tw-p-2" style="position: sticky;top: 0px;z-index: 100;background: #fff;">
          <h3>Source ayah/phrase</h3>
          <%
            ayah, range = @phrase_search.source_verse_and_range
            range ||= [-1, -1]
          %>

          <div class="tw-flex tw-gap-4">
            <div class="tw-w-full md:tw-w-1/2">
              <div class="tw-tw-mb-4">
                <%= f.label :ayah_key, 'Selected ayah' %>
                <%= f.select :ayah_key, options_for_select(Verse.order('id asc').pluck(:verse_key, :verse_key), selected: ayah&.verse_key), { include_blank: true }, class: 'tw-w-full tw-px-3 tw-py-2 tw-border tw-border-gray-300 tw-rounded-md tw-focus:tw-outline-none tw-focus:tw-ring-2 tw-focus:tw-ring-blue-500 tw-focus:tw-border-transparent', id: 'source_ayah', data: { placeholder: 'Select ayah', controller: 'select2' } %>
              </div>
            </div>

            <div class="tw-w-full md:tw-w-1/2">
              <div class="tw-flex tw-gap-4">
                <div class="tw-w-full md:tw-w-1/2">
                  <div class="tw-tw-mb-4">
                    <%= f.label :word_from, 'Word from' %>
                    <%= f.select :word_from, options_for_select(ayah.words.map do |w|
                      ["#{w.position} - #{w.text_qpc_hafs} ", w.position]
                    end, selected: range[0]), { include_blank: true }, class: 'tw-w-full tw-px-3 tw-py-2 tw-border tw-border-gray-300 tw-rounded-md tw-focus:tw-outline-none tw-focus:tw-ring-2 tw-focus:tw-ring-blue-500 tw-focus:tw-border-transparent word-from', data: { placeholder: 'Select starting word', controller: 'select2' } %>
                  </div>
                </div>

                <div class="tw-w-full md:tw-w-1/2">
                  <div class="tw-tw-mb-4">
                    <%= f.label :word_to, 'Word to' %>
                    <%= f.select :word_to, options_for_select(ayah.words.map do |w|
                      ["#{w.position} - #{w.text_qpc_hafs} ", w.position]
                    end, selected: range[1]), { include_blank: true }, class: 'tw-w-full tw-px-3 tw-py-2 tw-border tw-border-gray-300 tw-rounded-md tw-focus:tw-outline-none tw-focus:tw-ring-2 tw-focus:tw-ring-blue-500 tw-focus:tw-border-transparent word-to', data: { placeholder: 'Select ending word', controller: 'select2' } %>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <input type="text"
                 name="text"
                 id="text"
                 class="tw-w-full tw-px-3 tw-py-2 tw-border tw-border-gray-300 tw-rounded-md tw-focus:tw-outline-none tw-focus:tw-ring-2 tw-focus:tw-ring-blue-500 tw-focus:tw-border-transparent quran-text qpc-hafs"
                 value="<%= @phrase_search.phrase_text %>">
          <div class="tw-flex quran-text flex-wrap">
            <div>
              <%= ayah.verse_key %>
            </div>

            <% ayah.words.each do |w| %>
              <% if !w.ayah_mark? %>
                <div class="tw-flex flex-column m-3 tw-items-center">
                <span class="quran-text qpc-hafs <%= 'text-success' if w.position >= range[0].to_f && w.position <= range[1].to_f %>">
                  <%= w.text_qpc_hafs %>
                </span>
                </div>
              <% end %>
            <% end %>
          </div>
        </figure>

        <div class="filters tw-flex tw-flex-wrap tw-gap-4">
          <div class="tw-w-full">
            <div class="tw-flex tw-justify-between tw-items-center">
              <div class="tw-tw-mb-4">
                <div class="tw-flex tw-items-center tw-tw-mb-2">
                  <%= check_box_tag :use_text_search, 1, params[:use_text_search].blank? || params[:use_text_search].to_i == 1, id: 'use_text_search', class: 'tw-w-4 tw-h-4 tw-rounded tw-border-gray-300 tw-text-blue-600 focus:tw-ring-blue-500' %>
                  <%= label_tag :use_text_search, 'Use text search', class: 'tw-ml-2 tw-text-gray-700 tw-cursor-pointer' %>
                </div>

                <div class="tw-flex tw-items-center tw-tw-mb-2">
                  <%= check_box_tag :use_root_search, 1, params[:use_root_search].to_i == 1, id: 'use_root_search', class: 'tw-w-4 tw-h-4 tw-rounded tw-border-gray-300 tw-text-blue-600 focus:tw-ring-blue-500' %>
                  <%= label_tag :use_root_search, 'Use root search', class: 'tw-ml-2 tw-text-gray-700 tw-cursor-pointer' %>
                </div>

                <div class="tw-flex tw-items-center tw-tw-mb-2">
                  <%= check_box_tag :use_lemma_search, 1, params[:use_lemma_search].to_i == 1, id: 'use_lemma_search', class: 'tw-w-4 tw-h-4 tw-rounded tw-border-gray-300 tw-text-blue-600 focus:tw-ring-blue-500' %>
                  <%= label_tag :use_lemma_search, 'Use lemma search', class: 'tw-ml-2 tw-text-gray-700 tw-cursor-pointer' %>
                </div>

                <div class="tw-flex tw-items-center tw-tw-mb-2">
                  <%= check_box_tag :use_lcs_search, 1, params[:use_lcs_search].to_i == 1, id: 'use_lcs_search', class: 'tw-w-4 tw-h-4 tw-rounded tw-border-gray-300 tw-text-blue-600 focus:tw-ring-blue-500' %>
                  <%= label_tag :use_lcs_search, 'Use LCS search', class: 'tw-ml-2 tw-text-gray-700 tw-cursor-pointer' %>
                </div>
              </div>

              <div class="tw-tw-mb-4">
                <%= submit_tag 'Filter', class: 'tw-px-4 tw-py-2 tw-rounded tw-font-medium tw-transition-colors tw-bg-blue-600 hover:tw-bg-blue-700 tw-text-white', data: { disable_with: 'Please wait..' } %>
              </div>
            </div>
          </div>
        </div>

        <figure class="highlight tw-tw-mt-4 tw-border tw-border-gray-300 tw-my-2 tw-tw-p-2">
          <ul class="nav nav-tabs nav-tabs-clean" role="tablist">
            <li class="tw-m-0">
              <a class="tw-text-gray-700 tw-font-medium tw-no-underline tw-px-3 tw-py-2 tw-rounded hover:tw-bg-gray-200 active"
                 data-action="click->tabs#switch"
                 data-bs-target="#tab-suggestions"
                 role="tab" aria-selected="true">
                Suggestions
                <span class="badge tw-bg-green-500 tw-ms-1">
                  <%= @suggestions.keys.size %>
                </span>
              </a>
            </li>

            <li class="tw-m-0">
              <a class="tw-text-gray-700 tw-font-medium tw-no-underline tw-px-3 tw-py-2 tw-rounded hover:tw-bg-gray-200"
                 data-action="click->tabs#switch"
                 data-bs-target="#tab-ayahs"
                 role="tab" aria-selected="false">
                Ayahs
              </a>
            </li>
          </ul>

          <div class="tab-content tw-tw-p-3">
            <div class="tab-pane fade active show" id="tab-suggestions" role="tabpanel" aria-labelledby="tab-suggestions">
              <div id="suggestions">
                <%= render 'add_ayah' %>

                <div id=suggested-ayahs>
                  <% @suggestions.each do |key, suggestion| %>
                    <%= render 'ayah', options: suggestion %>
                  <% end %>
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="tab-ayahs" role="tabpanel" aria-labelledby="tab-ayahs">
              <% if @phrase&.persisted? %>
                <%= turbo_frame_tag 'phrase-verses', src: morphology_phrase_path(@phrase.id, result_type: 'preview'), loading: "lazy", target: 'self' do
                  'Loading please wait..'
                end %>
              <% else %>
                WIP
              <% end %>
            </div>
          </div>
        </figure>
      </div>
    <% end %>
  </div>
</div>
