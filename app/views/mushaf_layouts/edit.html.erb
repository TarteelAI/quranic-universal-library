<%
  page_number = @mushaf_page.page_number.to_i

  pdf_page_offset = (@resource.meta_value('source_pdf_page_offset') || 2).to_i

  actions = []
  more_action = []
  turbo_page_options = { turbo_frame: 'page', turbo_method: 'get', turbo_action: "replace" }
  turbo_mushaf_page_options = { turbo_frame: 'mushaf-page', turbo_method: 'get', turbo_action: "replace" }

  if @access
    more_action << link_to('Update page ayah mapping', mushaf_layout_path(@mushaf.id, page_number: page_number, view_type: 'page_mapping'), class: 'dropdown-item', data: turbo_page_options)
    more_action << link_to('Fix line alignment', mushaf_layout_path(@mushaf.id, page_number: page_number, view_type: 'line_alignment'), class: 'dropdown-item', data: turbo_page_options)
  end

  more_action << link_to('Proofreading view(With pdf)', mushaf_layout_path(@mushaf.id, page_number: page_number, view_type: 'proofreading'), class: 'dropdown-item', data: turbo_page_options)
  more_action << link_to('Preview Page', mushaf_layout_path(@mushaf.id, page_number: page_number), class: 'dropdown-item', data: turbo_page_options)
  more_action << link_to('Compare with', '#_', class: 'dropdown-item', data: { controller: 'ajax-modal', url: mushaf_layout_path(@mushaf.id, page_number: page_number, view_type: 'select_compare_mushaf') })
  more_action << link_to('Jump to page', '#_', class: 'dropdown-item', data: { controller: 'ajax-modal', url: mushaf_layout_path(@mushaf.id, page_number: page_number, view_type: 'select_page', previous_view_type: params[:view_type], compare: @compared_mushaf&.id, edit: true) })

  actions << "<div class='dropdown'>
      <button class='btn btn-primary dropdown-toggle' type='button' data-bs-toggle='dropdown' aria-expanded='false'>
        Actions
      </button>
      <ul class='dropdown-menu text-dark'>
       #{more_action.map do |action|
    "<li>#{action}</li>"
  end.join('')
  }
    </ul>
    </div>"

  actions << link_to('Previous Page', edit_mushaf_layout_path(@mushaf.id, compare: @compared_mushaf&.id, page_number: page_number - 1, view_type: params[:view_type]), class: 'btn btn-dark', data: turbo_mushaf_page_options)
  actions << link_to('Next page', edit_mushaf_layout_path(@mushaf.id, compare: @compared_mushaf&.id, page_number: page_number + 1, view_type: params[:view_type]), class: 'btn btn-dark', data: turbo_mushaf_page_options)

  actions << link_to('Back to filter', mushaf_layouts_path, class: 'btn btn-info')
%>

<%= turbo_frame_tag :page do %>
  <%= render 'tools/header',
             name: 'Mushaf layouts',
             title: "#{@mushaf.name}<br/><div style='font-size: 0.5em'>(Pg##{page_number} Ayahs: #{@mushaf_page.first_ayah_key} - #{@mushaf_page.last_ayah_key})</div>",
             key: 'mushaf_layout',
             actions: actions
  %>

  <%= render 'shared/access_message' %>

  <div class="page-wrapper tw-container tw-max-w-7xl tw-mx-auto tw-px-4">
    <% if @ayah_range_missing %>
      <div class="tw-max-w-2xl tw-mx-auto tw-mt-8">
        <div class="tw-bg-blue-50 tw-border-l-4 tw-border-blue-500 tw-p-6 tw-rounded-lg">
          <div class="tw-flex tw-items-start">
            <div class="tw-flex-shrink-0">
              <svg class="tw-h-8 tw-w-8 tw-text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div class="tw-ml-4 tw-flex-1">
              <h3 class="tw-text-lg tw-font-semibold tw-text-blue-900 tw-mb-2">
                Ayah Range Required
              </h3>
              <p class="tw-text-blue-800 tw-mb-4">
                Before you can map words for page <%= page_number %>, you need to set the Ayah range first. This defines which verses appear on this page.
              </p>
              <div class="tw-flex tw-gap-3">
                <%= link_to mushaf_layout_path(@mushaf.id, page_number: page_number, view_type: 'page_mapping'), class: 'btn btn-primary', data: { turbo_frame: '_top' } do %>
                  <span>Set Ayah Range</span>
                <% end %>
                <%= link_to 'Back to Pages', mushaf_layout_path(@mushaf.id), class: 'btn btn-secondary', data: { turbo_frame: '_top' } %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <%= render SplitScreenComponent.new do |component| %>
        <%= component.with_left do %>
          <%= render 'shared/pdf_or_archive_embed', jump_to_page: page_number + pdf_page_offset, page_offset: pdf_page_offset %>
        <% end %>

        <%= component.with_right do %>
        <%= turbo_frame_tag "mushaf-page" do %>
          <div data-page="<%= page_number %>"
               data-controller="update-mushaf-page mushaf-page-builder">
            <%= render 'shared/page_font', pages: [page_number] %>

            <div class="tw-text-center tw-mb-3 tw-border-b tw-border-gray-300 tw-p-2 resize-heading">
              <label>
                <input type="checkbox" checked id="propagate-changes">
                Propagate changes (page: <%= page_number %>)
              </label>
              <button class="tw-px-4 tw-py-2 tw-rounded tw-font-medium tw-transition-colors tw-bg-red-500 hover:tw-bg-red-600 tw-text-white mx-4" id="decrement" title="Decrement line number by 1 for all words" data-controller="tooltip">-1</button>
              <button class="tw-px-4 tw-py-2 tw-rounded tw-font-medium tw-transition-colors tw-bg-blue-500 hover:tw-bg-blue-600 tw-text-white" id=increment title="Increment line number by 1 for all words" data-controller="tooltip">+1</button>
            </div>

            <%= form_with model: @mushaf, url: mushaf_layout_path(@mushaf.id, page_number: page_number) do |form| %>
              <div class="mushaf-layout-form indopak">
                <% word_index = 1 %>
                <% @verses.each do |verse| %>
                  <div class="verse" data-verse="<%= verse.id %>">
                    <span class="word-group"> <%= verse.verse_key %></span>
                    <% verse.words.order('position ASC').each_with_index do |word, i| %>
                      <%
                        word_position = @words.detect do |w|
                          w.word_id == word.id
                        end
                      %>

                      <div class="word word-group" data-word="<%= word.id %>">
                        <div class="p<%= page_number %>-<%= @mushaf_page.mushaf.default_font_name %>">
                          <%= word.text_for_mushaf(@mushaf_page.mushaf_id) %>
                        </div>

                        <input
                          title="Select page"
                          type="number"
                          min=0
                          data-controller="tooltip"
                          max="<%= @lines_per_page %>"
                          class="line-number-input"
                          data-verse="<%= verse.id %>"
                          data-key="<%= verse.verse_key %>"
                          data-position="<%= word_index += 1 %>"
                          data-word-position="<%= i %>"
                          value="<%= word_position&.line_number.to_i %>"
                          style="min-width: 100px; font-size: 20px; font-weight: bold;"
                          name="layout[words][<%= word.id %>][line_number]"
                          required
                          />
                        <div class="fs-xs tw-text-sm tw-text-gray-600 tw-mt-1">
                          <%= word.location %>
                        </div>
                      </div>

                    <% end %>
                    <button class="remove-ayah tw-px-4 tw-py-2 tw-rounded tw-font-medium tw-transition-colors btn-default has-tooltip" title="Remove this ayah from page">X</button>
                  </div>
                <% end %>
              </div>

              <div class="tw-flex tw-justify-center tw-p-4">
                <%= link_to 'Cancel', mushaf_layout_path(@mushaf.id, page_number: page_number), class: 'btn btn-default', style: 'margin-right: 50px' %>
                <%= form.submit "Save", class: 'btn btn-success', data: { disable_with: 'Please wait...' } %>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    <% end %>
    <% end %>
  </div>
<% end %>