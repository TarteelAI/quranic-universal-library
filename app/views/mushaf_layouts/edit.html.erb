<%
  page_number = @mushaf_page.page_number.to_i
  ayah_range_missing = @mushaf_page.first_verse_id.nil? || @mushaf_page.last_verse_id.nil?

  pdf_page_offset = (@resource.meta_value('source_pdf_page_offset') || 2).to_i

  actions = []
  more_action = []
  turbo_page_options = { turbo_frame: 'page', turbo_method: 'get', turbo_action: "replace" }
  turbo_mushaf_page_options = { turbo_frame: 'mushaf-page', turbo_method: 'get', turbo_action: "replace" }

  if @access
    more_action << link_to('Set Ayah Range', mushaf_layout_path(@mushaf.id, page_number: page_number, view_type: 'page_mapping'), class: 'tw-block tw-px-4 tw-py-2 tw-text-sm tw-text-gray-700 hover:tw-bg-gray-100', data: turbo_page_options)
    more_action << link_to('Fix line alignment', mushaf_layout_path(@mushaf.id, page_number: page_number, view_type: 'line_alignment'), class: 'tw-block tw-px-4 tw-py-2 tw-text-sm tw-text-gray-700 hover:tw-bg-gray-100', data: turbo_page_options)
  end

  more_action << link_to('Proofreading view(With pdf)', mushaf_layout_path(@mushaf.id, page_number: page_number, view_type: 'proofreading'), class: 'tw-block tw-px-4 tw-py-2 tw-text-sm tw-text-gray-700 hover:tw-bg-gray-100', data: turbo_page_options)
  more_action << link_to('Preview Page', mushaf_layout_path(@mushaf.id, page_number: page_number), class: 'tw-block tw-px-4 tw-py-2 tw-text-sm tw-text-gray-700 hover:tw-bg-gray-100', data: turbo_page_options)
  more_action << link_to('Compare with', '#_', class: 'tw-block tw-px-4 tw-py-2 tw-text-sm tw-text-gray-700 hover:tw-bg-gray-100', data: { controller: 'ajax-modal', url: mushaf_layout_path(@mushaf.id, page_number: page_number, view_type: 'select_compare_mushaf') })
  more_action << link_to('Jump to page', '#_', class: 'tw-block tw-px-4 tw-py-2 tw-text-sm tw-text-gray-700 hover:tw-bg-gray-100', data: { controller: 'ajax-modal', url: mushaf_layout_path(@mushaf.id, page_number: page_number, view_type: 'select_page', previous_view_type: params[:view_type], compare: @compared_mushaf&.id, edit: true) })

  actions << "<div class='tw-relative' data-controller='dropdown'>
      <button class='tw-px-4 tw-py-2 tw-text-sm tw-font-medium tw-bg-green-600 hover:tw-bg-green-700 tw-text-white tw-rounded tw-transition-colors' type='button' data-action='click->dropdown#toggle' aria-expanded='false'>
        Actions
      </button>
      <ul class='tw-absolute tw-right-0 tw-mt-2 tw-w-56 tw-rounded-md tw-shadow-lg tw-bg-white tw-ring-1 tw-ring-black tw-ring-opacity-5 tw-z-50 tw-hidden' data-dropdown-target='menu'>
       #{more_action.map do |action|
    "<li>#{action}</li>"
  end.join('')
  }
    </ul>
    </div>"

  actions << link_to('Previous Page', edit_mushaf_layout_path(@mushaf.id, compare: @compared_mushaf&.id, page_number: page_number - 1, view_type: params[:view_type]), class: 'tw-px-4 tw-py-2 tw-text-sm tw-font-medium tw-bg-gray-800 hover:tw-bg-gray-900 tw-text-white tw-rounded tw-transition-colors', data: turbo_mushaf_page_options)
  actions << link_to('Next page', edit_mushaf_layout_path(@mushaf.id, compare: @compared_mushaf&.id, page_number: page_number + 1, view_type: params[:view_type]), class: 'tw-px-4 tw-py-2 tw-text-sm tw-font-medium tw-bg-gray-800 hover:tw-bg-gray-900 tw-text-white tw-rounded tw-transition-colors', data: turbo_mushaf_page_options)

  actions << link_to('Back to mushaf list', mushaf_layouts_path, class: 'btn btn-info')
%>

<%= turbo_frame_tag :page do %>
  <%= render 'tools/header',
             name: 'Mushaf layouts',
             title: "#{@mushaf.name}<br/><div style='font-size: 0.5em'>(Pg##{page_number} Ayahs: #{@mushaf_page.first_ayah_key} - #{@mushaf_page.last_ayah_key})</div>",
             key: 'mushaf_layout',
             actions: actions
  %>

  <%= render 'shared/access_message' %>

  <div class="page-wrapper tw-container tw-max-w-7xl tw-mx-auto tw-px-4">
    <%= turbo_frame_tag "mushaf-page" do %>
      <% if ayah_range_missing %>
        <%= render 'missing_required_data', step: 'word_mapping' %>
      <% else %>
        <%= render SplitScreenComponent.new do |component| %>
          <%= component.with_left do %>
            <%= render 'shared/pdf_or_archive_embed', jump_to_page: page_number + pdf_page_offset, page_offset: pdf_page_offset %>
          <% end %>

          <%= component.with_right do %>
          <div data-page="<%= page_number %>"
               data-controller="update-mushaf-page mushaf-page-builder">
            <%= render 'shared/page_font', pages: [page_number] %>

            <div class="page-controls tw-text-center tw-mb-3 tw-border-b tw-border-gray-300 tw-p-2 resize-heading">
              <label>
                <input type="checkbox" checked id="propagate-changes">
                Propagate changes (page: <%= page_number %>)
              </label>

              <div class="tw-inline-flex tw-gap-2 tw-ml-4">
                <button class="tw-px-4 tw-py-2 tw-rounded tw-font-medium tw-transition-colors tw-bg-red-500 hover:tw-bg-red-600 tw-text-white mx-4" id="decrement" title="Decrement line number by 1 for all words" data-controller="tooltip">-1</button>
                <button class="tw-px-4 tw-py-2 tw-rounded tw-font-medium tw-transition-colors tw-bg-blue-500 hover:tw-bg-blue-600 tw-text-white" id=increment title="Increment line number by 1 for all words" data-controller="tooltip">+1</button>

                <button type="button" id="undo-button" class="tw-px-3 tw-py-1.5 tw-text-xs tw-font-medium tw-bg-gray-500 hover:tw-bg-gray-600 tw-text-white tw-rounded tw-transition-colors" title="Undo (Ctrl+Z)" data-controller="tooltip" disabled>
                  <svg class="tw-w-4 tw-h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                  </svg>
                  Undo
                </button>

                <button type="button" id="redo-button" class="tw-px-3 tw-py-1.5 tw-text-xs tw-font-medium tw-bg-gray-500 hover:tw-bg-gray-600 tw-text-white tw-rounded tw-transition-colors" title="Redo (Ctrl+Y)" data-controller="tooltip" disabled>
                  <svg class="tw-w-4 tw-h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10H11a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"/>
                  </svg>
                  Redo
                </button>
              </div>
            </div>

            <%= form_with model: @mushaf, url: mushaf_layout_path(@mushaf.id, page_number: page_number) do |form| %>
              <div class="mushaf-layout-form indopak">
                <% word_index = 1 %>
                <% @verses.each do |verse| %>
                  <div class="verse" data-verse="<%= verse.id %>">
                    <span class="word-group"> <%= verse.verse_key %></span>
                    <% verse.words.order('position ASC').each_with_index do |word, i| %>
                      <%
                        word_position = @words.detect do |w|
                          w.word_id == word.id
                        end
                      %>

                      <div class="word word-group" data-word="<%= word.id %>">
                        <div class="p<%= page_number %>-<%= @mushaf_page.mushaf.default_font_name %>">
                          <%= word.text_for_mushaf(@mushaf_page.mushaf_id) %>
                        </div>

                        <input
                          title="Select page"
                          type="number"
                          min=0
                          data-controller="tooltip"
                          max="<%= @lines_per_page %>"
                          class="line-number-input"
                          data-verse="<%= verse.id %>"
                          data-key="<%= verse.verse_key %>"
                          data-position="<%= word_index += 1 %>"
                          data-word-position="<%= i %>"
                          value="<%= word_position&.line_number.to_i %>"
                          style="min-width: 100px; font-size: 20px; font-weight: bold;"
                          name="layout[words][<%= word.id %>][line_number]"
                          required
                          />
                        <div class="fs-xs tw-text-sm tw-text-gray-600 tw-mt-1">
                          <%= word.location %>
                        </div>
                      </div>

                    <% end %>
                    <button class="remove-ayah tw-px-4 tw-py-2 tw-rounded tw-font-medium tw-transition-colors btn-default has-tooltip" title="Remove this ayah from page">X</button>
                  </div>
                <% end %>
              </div>

              <div class="tw-flex tw-justify-center tw-p-4">
                <%= link_to 'Cancel', mushaf_layout_path(@mushaf.id, page_number: page_number), class: 'tw-px-4 tw-py-2 tw-text-sm tw-font-medium tw-bg-gray-200 hover:tw-bg-gray-300 tw-text-gray-800 tw-rounded tw-transition-colors', style: 'margin-right: 50px' %>
                <%= form.submit "Save", class: 'tw-px-4 tw-py-2 tw-text-sm tw-font-medium tw-bg-green-600 hover:tw-bg-green-700 tw-text-white tw-rounded tw-transition-colors', data: { disable_with: 'Please wait...' } %>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    <% end %>
    <% end %>
  </div>
<% end %>