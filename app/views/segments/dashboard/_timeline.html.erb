<div class="page-wrapper container-lg">
  <div class="page-section filters">
    <%= form_tag segments_timeline_path, method: :get do %>
      <div data-controller="chapter-verses-filter" class="d-flex tw-flex-wrap">
        <div class="form-group me-2">
          <%= select_tag :surah, options_for_select(@presenter.chapter_options, @presenter.selected_surah), include_blank: true, class: 'form-select tw-w-[85vw] sm:tw-w-auto ', id: 'chapter-select', data: { controller: 'select2' } %>
          <p class="form-text">Filter by Surah</p>
        </div>

        <div class="form-group me-2">
          <%= select_tag :reciter, options_for_select(@presenter.reciters.pluck(:name, :id), @presenter.selected_reciter), include_blank: true, class: 'form-select tw-w-[85vw] sm:tw-w-[200px]', data: { controller: 'select2' } %>
          <p class="form-text">Filter reciter</p>
        </div>

        <div class="form-group">
          <%= submit_tag 'Filter', class: 'btn btn-success', data: { disable_with: 'Please wait..' } %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="page-section tw-mt-4" data-controller="segments--timeline" data-ayah="<%= params[:ayah] %>">
    <% if @presenter.selected_reciter.present? && @presenter.selected_surah.present? %>
      <%
        data = @presenter.timeline_data
        reciter = data[:reciter]
        ayahs = data[:ayahs]
        ayah_positions = data[:ayah_positions]
        word_positions = data[:word_positions]
        failures = data[:failures]
        ayah_boundaries = data[:ayah_boundaries]
      %>

      <h2 class="tw-text-xl tw-font-bold tw-mb-4">
        Word-by-Word Timeline â€“ <%= reciter.name %>, Surah <%= @presenter.selected_surah %>
      </h2>

      <div class="tw-space-y-4">
        <% ayahs.each do |ayah| %>
          <%
            ayah_position = ayah_positions[ayah.verse_number]
            ayah_boundary = ayah_boundaries[ayah.verse_number]

            if ayah_boundary.nil?
              if ayah.verse_number == 1
                ayah_start_time = 0
                ayah_end_time = ayah_positions[ayah.verse_number + 1]&.first&.start_time
              end
            else
              ayah_start_time = ayah_boundary.start_time
              ayah_end_time = ayah_boundary.end_time
              gap_start_time = ayah_boundary.gap_start_time
              gap_end_time = ayah_boundary.gap_end_time
            end
          %>

          <div
            data-ayah="<%= ayah.verse_number %>"
          >
            <h3 class="tw-font-semibold tw-mb-2">
              Ayah <%= ayah.verse_key %>
              <span class="tw-text-gray-500 tw-text-sm">
                (<%= ayah_start_time %> - <%= ayah_end_time %>)
                (<%= [[ayah_start_time.to_i, gap_end_time + 100].min, gap_start_time, gap_end_time].join(' - ') %>)
                <% if ayah_position.nil? %>
                 <span class="tw-text-red-500">estimated</span>
                <% end %>
              </span>

              <button
                data-start="<%= ayah_start_time.to_i %>"
                data-end="<%= ayah_end_time.to_i %>"
                class="play-segment tw-bg-orange-400 tw-text-white tw-px-2 tw-py-1 tw-rounded tw-text-sm hover:tw-bg-orange-500 hover:tw-text-white"
              > Play
              </button>
              <button
                data-start="<%= [ayah_start_time.to_i, gap_end_time].min  %>"
                data-end="<%= ayah_end_time.to_i %>"
                class="play-segment tw-bg-orange-400 tw-text-white tw-px-2 tw-py-1 tw-rounded tw-text-sm hover:tw-bg-orange-500 hover:tw-text-white"
              > Play Gap
              </button>
              <%= link_to 'logs', segments_logs_path(reciter: reciter.id, surah: @presenter.selected_surah), class: 'tw-bg-blue-400 tw-text-white tw-px-2 tw-py-1 tw-rounded tw-text-sm hover:tw-bg-blue-500 hover:tw-text-white', target: '_blank' %>
              <%= link_to 'Segment', "/surah_audio_files/#{reciter.id}/segment_builder?chapter_id=#{@presenter.selected_surah}&verse=#{ayah.verse_number}", class: 'tw-bg-green-400 tw-text-white tw-px-2 tw-py-1 tw-rounded tw-text-sm hover:tw-bg-green-500 hover:tw-text-white', target: '_blank' %>
            </h3>

            <div class="tw-flex tw-gap-1 tw-flex-wrap qpc-hafs">
              <% ayah.words.each do |word| %>
                <%
                  #TODO: move this to presenter
                  key = word.location
                  failure = failures[key]
                  correction = []

                  if position = word_positions[key]
                    correction = [position.corrected_start_time, position.corrected_end_time]
                    color = "tw-bg-green-500"

                    if failure&.corrected?
                      color = "tw-bg-red-500 tw-border-2 tw-border-green-300"
                    end

                    start_time = position.start_time
                    end_time = position.end_time
                  elsif failure
                    color = "tw-bg-red-500"

                    start_time = failure.start_time
                    end_time = failure.end_time
                    correction = [failure.corrected_start_time, failure.corrected_end_time]

                    if failure.corrected?
                      color << " tw-border-2 tw-border-green-300"

                      start_time ||= failure.corrected_start_time
                      end_time ||= failure.corrected_end_time
                    end
                  else
                    color = "tw-bg-gray-300"
                    start_time = nil
                    end_time = nil
                  end
                %>

                <button
                  class="play-segment tw-px-2 tw-py-1 tw-rounded tw-text-sm <%= color %>"
                  data-start="<%= start_time %>"
                  data-end="<%= end_time %>"
                  data-controller="tooltip"

                  <% if failure %>
                  title="<div><strong><%= failure.failure_type %></strong><div>Expected: <span class=qpc-hafs><%= failure.expected_transcript %></span></div><div>Received: <span class=qpc-hafs><%= failure.received_transcript %></span></div><div>Time: <%= start_time %> .. <%= end_time %> </div><div>Corrected time: <%= correction.join('...') %></div></div>"
                  <% else %>
                  title="<div><div>Time: <%= start_time %> .. <%= end_time %> </div><div>Corrected Time: <%= correction.join('...') %> </div></div>"
                  <% end %>
                  <%= "disabled" unless start_time && end_time %>
                  >
                  <%= word.text_qpc_hafs %>
                </button>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <audio id="player" src="<%= reciter.audio_url(@presenter.selected_surah) %>" controls class="tw-mt-6 tw-w-full"></audio>
    <% else %>
      Please select a Surah and Reciter to view the timeline.
    <% end %>
  </div>
</div>