<div class="page-wrapper container-lg">
  <div class="page-section filters" style="position: relative">
    <%= form_tag segments_timeline_path, method: :get do %>
      <div data-controller="chapter-verses-filter" class="d-flex tw-flex-wrap">
        <div class="form-group me-2">
          <%= select_tag :surah, options_for_select(@presenter.chapter_options, @presenter.selected_surah), include_blank: true, class: 'form-select tw-w-[85vw] sm:tw-w-auto ', id: 'chapter-select', data: { controller: 'select2' } %>
          <p class="form-text">Filter by Surah</p>
        </div>

        <div class="form-group me-2">
          <%= select_tag :reciter, options_for_select(@presenter.reciters.pluck(:name, :id), @presenter.selected_reciter), include_blank: true, class: 'form-select tw-w-[85vw] sm:tw-w-[200px]', data: { controller: 'select2' } %>
          <p class="form-text">Filter reciter</p>
        </div>

        <div class="form-group">
          <%= submit_tag 'Filter', class: 'btn btn-success', data: { disable_with: 'Please wait..' } %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="page-section tw-mt-4" data-controller="segments--timeline" data-ayah="<%= params[:ayah] %>">
    <% if @presenter.selected_reciter.present? && @presenter.selected_surah.present? %>
      <%
        data = @presenter.timeline_data
        reciter = data[:reciter]
        ayahs = data[:ayahs]
        ayah_positions = data[:ayah_positions]
        word_positions = data[:word_positions]
        failures = data[:failures]
        ayah_boundaries = data[:ayah_boundaries]

        # Prepare ayah timing data for JavaScript
        ayah_timing_data = {}

        ayahs.each do |ayah|
          ayah_boundary = ayah_boundaries[ayah.verse_number]

          if ayah_boundary
            ayah_timing_data[ayah.verse_number] = {
              start_time: ayah_boundary.start_time,
              end_time: ayah_boundary.end_time,
              words: ayah_boundary.words_data
            }
          end
        end
      %>

      <script type="application/json" id="ayah-timing-data">
        <%= raw ayah_timing_data.to_json %>
      </script>

      <style>
         .currently-playing{
            background: #fbbf24 !important; /* Tailwind yellow-400 */
         }
          #audio-drop-zone.drag-over {
              @apply tw-border-blue-500 tw-bg-blue-100 tw-border-solid;
          }

          #audio-drop-zone.drag-over svg {
              @apply tw-text-blue-500;
          }

          #audio-drop-zone.drag-over .tw-text-gray-600 {
              @apply tw-text-blue-700;
          }

          /* Fallback for browsers that don't support Tailwind's @apply */
          #audio-drop-zone.drag-over {
              border-color: #3b82f6 !important;
              background-color: #dbeafe !important;
              border-style: solid !important;
          }

          #audio-drop-zone.drag-over svg {
              color: #3b82f6 !important;
          }
      </style>

      <h2 class="tw-text-xl tw-font-bold tw-mb-4">
        Word-by-Word Timeline – <%= reciter.name %>, Surah <%= @presenter.selected_surah %>
      </h2>

      <!-- Audio File Upload Section -->
      <div class="tw-bg-gray-50 tw-p-4 tw-rounded-lg tw-mb-4">
        <h3 class="tw-text-lg tw-font-semibold tw-mb-3 tw-text-gray-700">Audio Source</h3>

        <!-- Drag and Drop Zone -->
        <div id="audio-drop-zone" class="tw-border-2 tw-border-dashed tw-border-gray-300 tw-rounded-lg tw-p-6 tw-mb-4 tw-text-center tw-transition-colors hover:tw-border-blue-400 hover:tw-bg-blue-50 tw-cursor-pointer">
          <div class="tw-flex tw-flex-col tw-items-center tw-space-y-2">
            <div class="tw-text-gray-600">
              <span class="tw-font-medium">Drop your audio file here</span> or <span class="tw-text-blue-500 tw-font-medium">click to browse</span>
            </div>
            <div class="tw-text-xs tw-text-gray-500">
              Supports MP3, WAV, M4A, OGG and other audio formats
            </div>
          </div>
        </div>

        <div class="tw-flex tw-flex-col sm:tw-flex-row tw-gap-3 tw-items-start sm:tw-items-center">
          <div class="tw-flex tw-items-center tw-gap-2">
            <label for="audio-file-input" class="tw-bg-blue-500 hover:tw-bg-blue-600 tw-text-white tw-px-4 tw-py-2 tw-rounded tw-cursor-pointer tw-text-sm tw-font-medium tw-transition-colors">
              Choose Local File
              <input
                type="file"
                id="audio-file-input"
                accept="audio/*"
                class="tw-hidden"
                />
            </label>

            <button
              id="reset-audio-button"
              class="tw-bg-gray-500 hover:tw-bg-gray-600 tw-text-white tw-px-4 tw-py-2 tw-rounded tw-text-sm tw-font-medium tw-transition-colors"
              style="display: none;"
            >
              Reset to Original
            </button>
          </div>

          <div class="tw-flex tw-flex-col tw-gap-1">
            <div id="selected-file-name" class="tw-text-sm tw-text-gray-600 tw-font-medium" style="display: none;"></div>
            <div class="tw-text-xs tw-text-gray-500">
              Original: <%= reciter.audio_url(@presenter.selected_surah).split('/').last %>
            </div>
          </div>
        </div>

        <div class="tw-mt-2 tw-text-xs tw-text-gray-500">
          Upload a local audio file to test timing synchronization with different audio sources.
        </div>
      </div>

      <div class="tw-space-y-4">
        <% ayahs.each do |ayah| %>
          <%
            ayah_position = ayah_positions[ayah.verse_number]
            ayah_boundary = ayah_boundaries[ayah.verse_number]
            next_ayah_boundary = ayah_boundaries[ayah.verse_number + 1]

            if ayah_boundary.nil?
              if ayah.verse_number == 1
                ayah_start_time = 0
                ayah_end_time = ayah_positions[ayah.verse_number + 1]&.first&.start_time
              end
            else
              ayah_start_time = ayah_boundary.start_time
              ayah_end_time = ayah_boundary.end_time
              corrected_start_time = ayah_boundary.corrected_start_time
              corrected_end_time = ayah_boundary.corrected_end_time

              gap_start_time = ayah_boundary.gap_before_start_time
              gap_end_time = ayah_boundary.gap_before_end_time
              next_ayah_start_gap = next_ayah_boundary&.gap_before_start_time
            end
          %>

          <div
            data-ayah="<%= ayah.verse_number %>"
          >
            <h3 class="tw-font-semibold tw-mb-2">
              Ayah <%= ayah.verse_key %>
              <span class="tw-text-gray-500 tw-text-sm">
                (<%= ayah_start_time %> - <%= ayah_end_time %>)
                (✅<%= [corrected_start_time, corrected_end_time].join(' - ') if corrected_start_time &&  corrected_end_time %>)
                <% if ayah_position.nil? %>
                 <span class="tw-text-red-500">estimated</span>
                <% end %>
              </span>

              <button
                data-start="<%= ayah_start_time.to_i %>"
                data-end="<%= ayah_end_time.to_i %>"
                data-play-ayah="<%= ayah.verse_number %>"
                class="play-segment tw-bg-orange-400 tw-text-white tw-px-2 tw-py-1 tw-rounded tw-text-sm hover:tw-bg-orange-500 hover:tw-text-white"
              > Play
              </button>

                <button
                  data-start="<%= corrected_start_time  %>"
                  data-end="<%= corrected_end_time %>"
                  data-play-ayah="<%= ayah.verse_number %>"
                  class="play-segment tw-bg-orange-400 tw-text-white tw-px-2 tw-py-1 tw-rounded tw-text-sm hover:tw-bg-orange-500 hover:tw-text-white"
                > Play Corrected
                </button>

              <%= link_to 'logs', segments_logs_path(reciter: reciter.id, surah: @presenter.selected_surah), class: 'tw-bg-blue-400 tw-text-white tw-px-2 tw-py-1 tw-rounded tw-text-sm hover:tw-bg-blue-500 hover:tw-text-white', target: '_blank' %>
              <%= link_to 'Segment', "/surah_audio_files/#{reciter.id}/segment_builder?chapter_id=#{@presenter.selected_surah}&verse=#{ayah.verse_number}", class: 'tw-bg-green-400 tw-text-white tw-px-2 tw-py-1 tw-rounded tw-text-sm hover:tw-bg-green-500 hover:tw-text-white', target: '_blank' %>
            </h3>

            <div class="tw-flex tw-gap-1 tw-flex-wrap qpc-hafs words">
              <% ayah.words.each do |word| %>
                <%
                  #TODO: move this to presenter
                  key = word.location
                  failure = failures[key]
                  correction = []

                  if position = word_positions[key]
                    correction = [position.corrected_start_time, position.corrected_end_time]
                    color = "tw-bg-green-500"

                    if failure
                      color = "tw-bg-red-500 tw-border-2 tw-border-green-300"
                    end

                    start_time = position.start_time
                    end_time = position.end_time
                  elsif failure
                    color = "tw-bg-red-500"

                    start_time = failure.start_time
                    end_time = failure.end_time
                    correction = [failure.corrected_start_time, failure.corrected_end_time]

                    if failure.corrected?
                      color << " tw-border-2 tw-border-green-300"

                      start_time ||= failure.corrected_start_time
                      end_time ||= failure.corrected_end_time
                    end
                  else
                    color = "tw-bg-gray-300"
                    start_time = nil
                    end_time = nil
                  end
                %>

                <button
                  class="play-segment tw-px-2 tw-py-1 tw-rounded tw-text-sm <%= color %>"
                  data-start="<%= start_time %>"
                  data-end="<%= end_time %>"
                  data-controller="tooltip"
                  data-position="<%= word.position %>"
                  <% if failure %>
                  title="<div><strong><%= failure.failure_type %></strong><div>Expected: <span class=qpc-hafs><%= failure.expected_transcript %></span></div><div>Received: <span class=qpc-hafs><%= failure.received_transcript %></span></div><div>Time: <%= start_time %> .. <%= end_time %> </div><div>Corrected time: <%= correction.join('...') %></div></div>"
                  <% else %>
                  title="<div><div>Time: <%= start_time %> .. <%= end_time %> </div><div>Corrected Time: <%= correction.join('...') %> </div></div>"
                  <% end %>
                  <%= "disabled" unless start_time && end_time %>
                  >
                  <%= word.text_qpc_hafs %>
                </button>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <audio id="player" src="<%= reciter.audio_url(@presenter.selected_surah) %>" controls class="tw-mt-6 tw-w-full"
             style="position: sticky; bottom: 0"
      ></audio>

      <div class="tw-mt-4 tw-flex tw-items-center tw-gap-2">
        <label for="jump-to-input" class="tw-text-sm tw-font-medium tw-text-gray-700">Jump to (ms):</label>
        <input
          type="number"
          id="jump-to-input"
          class="tw-px-3 tw-py-1 tw-border tw-border-gray-300 tw-rounded tw-text-sm tw-w-24"
          placeholder="0"
          min="0"
          step="100"
          />
        <button
          id="jump-to-button"
          class="tw-px-3 tw-py-1 tw-bg-blue-500 tw-text-white tw-rounded tw-text-sm hover:tw-bg-blue-600"
        >
          Jump
        </button>
      </div>
    <% else %>
      Please select a Surah and Reciter to view the timeline.
    <% end %>
  </div>
</div>