<%
  page_data = @presenter.page_data
  words = page_data[:words]
  mistakes = page_data[:mistakes]
  lines = group_words_lines(words)
  lines_mapping = @presenter.line_mapping
  page_number = @presenter.page_number
%>

<div class="mushaf qpc-hafs">
  <div class="page-wrapper tw-container tw-max-w-7xl tw-mx-auto tw-px-4 flex">
    <div id="page-<%= page_number %>" class="page">
      <% 1.upto(15) do |line_number| %>
        <%
          line_mapping = lines_mapping[line_number] || MushafLineAlignment.dummy
          verses = lines[line_number] || []
        %>

        <% next if line_mapping.blank? && verses.blank? %>

        <div class="line-container" data-line="<%= line_number %>">
          <div class="line <%= 'line--center' if line_mapping.is_center_aligned? || line_mapping.is_bismillah? %> <%= 'line--surah-name' if line_mapping.is_surah_name? %> <%= 'line--bismillah' if line_mapping.is_bismillah? %>" id="line-<%= line_number %>">
            <% if line_mapping.is_surah_name? %>
              <%= render 'shared/chapter_name', chapter: Chapter.find_by(id: line_mapping.get_surah_number) %>
            <% end %>

            <% if line_mapping.is_bismillah? %>
              <%= render 'shared/bismillah' %>
            <% end %>

            <% verses.each do |verse_id, words| %>
              <div class="ayah-container">
                <div class="ayah" data-ayah="<%= verse_id %>">
                  <% words.each do |word| %>
                    <%
                      word_mistakes = mistakes[word.word_id] || []
                      full_word_mistake = word_mistakes.find { |m| m.full_word? }
                      partial_mistakes = word_mistakes.select { |m| m.partial_word? }
                    %>

                    <% if full_word_mistake %>
                      <%
                        text_color = @presenter.mistake_color(full_word_mistake.frequency)
                        glow = @presenter.mistake_glow_intensity(full_word_mistake.frequency)
                      %>
                      <span class="word-mistake-highlight"
                            id="word-<%= word.position_in_page %>"
                            data-word-id="<%= word.word_id %>"
                            data-id="<%= word.id %>"
                            style="color: <%= text_color %>; text-shadow: 0 0 <%= glow %>px <%= text_color %>; cursor: pointer;"
                      >
                          <%= link_to word.text, mistake_heatmap_word_details_path(word.word_id),
                                      class: "word-detail-link",
                                      style: "color: inherit; text-decoration: none;",
                                      data: { controller: 'ajax-modal', url: mistake_heatmap_word_details_path(word.word_id), css_class: 'modal-xl' } %>
                        </span>
                    <% elsif partial_mistakes.any? %>
                      <%
                        word_text = word.text || ''
                        highlighted_text = ''
                        last_pos = 0

                        partial_mistakes.sort_by(&:char_start).each do |mistake|
                          char_start = mistake.char_start
                          char_end = mistake.char_end
                          text_color = @presenter.mistake_color(mistake.frequency)
                          glow = @presenter.mistake_glow_intensity(mistake.frequency)

                          highlighted_text += word_text[last_pos...char_start].html_safe if last_pos < char_start
                          highlighted_text += content_tag(:span, word_text[char_start...char_end].html_safe,
                                                          class: 'word-mistake-highlight-partial',
                                                          style: "color: #{text_color}; text-shadow: 0 0 #{glow}px #{text_color};",
                                                          title: "Frequency: #{mistake.frequency}")
                          last_pos = char_end
                        end

                        highlighted_text += word_text[last_pos..-1].html_safe if last_pos < word_text.length
                      %>
                      <span class="char <%= word.css_class %> char-<%= word.char_type_name %>"
                            id="word-<%= word.position_in_page %>"
                            data-word-id="<%= word.word_id %>"
                            data-ayah="<%= word.word&.verse_key || word.verse&.verse_key %>"
                            data-id="<%= word.word_id %>"
                            style="cursor: pointer;">
                          <%= link_to highlighted_text.html_safe, mistake_heatmap_word_details_path(word.word_id),
                                      class: "word-detail-link",
                                      style: "color: inherit; text-decoration: none;",
                                      data: { controller: 'ajax-modal', url: mistake_heatmap_word_details_path(word.word_id), css_class: 'modal-xl' } %>
                        </span>
                    <% else %>
                        <span class="char <%= word.css_class %> char-<%= word.char_type_name %>"
                              id="word-<%= word.position_in_page %>"
                              data-word-id="<%= word.word_id %>"
                              data-ayah="<%= word.word&.verse_key || word.verse&.verse_key %>"
                              data-id="<%= word.id %>"
                              style="cursor: pointer;">
                          <%= link_to safe_html(word.text), mistake_heatmap_word_details_path(word.word_id),
                                      class: "word-detail-link",
                                      style: "color: inherit; text-decoration: none;",
                                      data: { controller: 'ajax-modal', url: mistake_heatmap_word_details_path(word.word_id), css_class: 'modal-xl' } %>
                        </span>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
