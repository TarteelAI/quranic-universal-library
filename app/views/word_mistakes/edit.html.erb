<%= render 'layouts/qul_head' %>

<%
  page_data = @presenter.page_data
  mistakes = page_data[:mistakes]
  words = page_data[:words]
  page_number = @presenter.page_number
%>

<%= form_with url: mistake_heatmap_path(page: page_number), method: :put, local: true, class: "tw-container tw-mx-auto tw-px-4 tw-py-6", data: { controller: "mistake-heatmap", "mistake-heatmap-update-url-value": mistake_heatmap_path(page: page_number) } do |form| %>
  <div class="tw-mb-6">
    <h1 class="tw-text-3xl tw-font-bold">Edit Word Mistakes - Page <%= page_number %></h1>
    <p class="tw-text-sm tw-text-gray-600 tw-mt-2">Changes save automatically as you type</p>
  </div>

  <div class="tw-mb-4 tw-p-4 tw-bg-yellow-50 tw-border tw-border-yellow-200 tw-rounded">
    <p class="tw-text-sm tw-text-yellow-800">
      <strong>Instructions:</strong> Enter mistake counts for words. To mark partial words, click "Select Range" and choose the character range from the dropdown, then enter the mistake count.
    </p>
  </div>

  <div class="tw-grid tw-grid-cols-1 lg:tw-grid-cols-2 tw-gap-6">
    <div>
      <h2 class="tw-text-xl tw-font-semibold tw-mb-4">Words on Page</h2>
      <div class="tw-space-y-2 tw-max-h-[600px] tw-overflow-y-auto">
        <% words.each_with_index do |word, index| %>
          <% 
            word_text = word.text || ''
            word_id = word.word_id
            existing_mistakes = mistakes[word_id] || []
            full_word_mistake = existing_mistakes.find { |m| m.full_word? }
            partial_mistakes = existing_mistakes.select { |m| m.partial_word? }
          %>
          
          <div class="tw-border tw-border-gray-200 tw-rounded tw-p-3 word-form-container" id="word-form-<%= word_id %>" data-word-id="<%= word_id %>">
            <div class="tw-flex tw-items-center tw-justify-between tw-mb-2">
              <span class="tw-font-medium">Word #<%= word.position_in_page %></span>
              <span class="tw-text-sm tw-text-gray-600"><%= word.word&.verse_key || word.verse&.verse_key %></span>
            </div>
            
            <div class="tw-mb-2 tw-p-2 tw-bg-gray-50 tw-rounded" dir="rtl" style="font-family: qpc-hafs, serif; font-size: 20px; text-align: center;">
              <span id="word-text-<%= word_id %>" data-text="<%= word_text %>"><%= safe_html word_text %></span>
            </div>

            <div class="tw-mb-2">
              <label class="tw-block tw-text-sm tw-font-medium tw-mb-1">Full Word Frequency (0-1):</label>
              <input type="number" 
                     step="0.01"
                     name="mistakes[<%= word_id %>_nil_nil][frequency]"
                     value="<%= full_word_mistake&.frequency || 0 %>"
                     min="0"
                     max="1"
                     class="tw-w-full tw-border tw-border-gray-300 tw-rounded tw-px-3 tw-py-1"
                     placeholder="Enter frequency (0-1)">
            </div>

            <div class="tw-mb-2">
              <button type="button" 
                      class="tw-text-sm tw-text-blue-600 hover:tw-text-blue-800 tw-underline"
                      onclick="togglePartialRangeSelector(<%= word_id %>, '<%= word_text %>')">
                Select Partial Word Range
              </button>
            </div>

            <div id="partial-range-selector-<%= word_id %>" class="tw-hidden tw-mb-2 tw-p-2 tw-bg-blue-50 tw-rounded">
              <div class="tw-mb-2">
                <label class="tw-block tw-text-xs tw-font-medium tw-mb-1">Click characters to select/unselect:</label>
                <div class="tw-flex tw-flex-wrap tw-gap-1 tw-p-2 tw-bg-white tw-rounded tw-border" dir="rtl">
                  <% word_text.chars.each_with_index do |char, idx| %>
                    <button type="button" 
                            class="partial-range-char tw-px-2 tw-py-1 tw-border tw-border-gray-300 tw-rounded tw-text-sm hover:tw-bg-blue-100"
                            data-char-index="<%= idx %>"
                            data-word-id="<%= word_id %>"
                            data-selected="false"
                            onclick="toggleCharSelection(this, <%= word_id %>)">
                      <span dir="rtl"><%= char %></span>
                    </button>
                  <% end %>
                </div>
              </div>
              <div class="tw-mb-2">
                <label class="tw-block tw-text-xs tw-font-medium tw-mb-1">Selected: <span id="selected-range-<%= word_id %>">-</span></label>
              </div>
              <div class="tw-flex tw-gap-2">
                <button type="button" 
                        class="tw-px-3 tw-py-1 tw-bg-green-500 tw-text-white tw-text-sm tw-rounded hover:tw-bg-green-600"
                        onclick="confirmPartialRange(<%= word_id %>, '<%= word_text.gsub("'", "\\'").gsub("\"", "&quot;") %>')">
                  Add Range
                </button>
                <button type="button" 
                        class="tw-px-3 tw-py-1 tw-bg-gray-500 tw-text-white tw-text-sm tw-rounded hover:tw-bg-gray-600"
                        onclick="cancelPartialRange(<%= word_id %>)">
                  Cancel
                </button>
              </div>
            </div>

            <div id="partial-mistakes-<%= word_id %>" class="tw-space-y-2">
              <% partial_mistakes.each do |mistake| %>
                <div class="tw-flex tw-gap-2 tw-items-center tw-bg-blue-50 tw-p-2 tw-rounded" data-partial-range="<%= mistake.char_start %>-<%= mistake.char_end %>">
                  <span class="tw-text-sm">Chars <%= mistake.char_start %>-<%= mistake.char_end %>:</span>
                  <input type="number" 
                         step="0.01"
                         name="mistakes[<%= word_id %>_<%= mistake.char_start %>_<%= mistake.char_end %>][frequency]"
                         value="<%= mistake.frequency || 0 %>"
                         min="0"
                         max="1"
                         class="tw-flex-1 tw-border tw-border-gray-300 tw-rounded tw-px-2 tw-py-1">
                  <button type="button" 
                          class="tw-text-red-600 hover:tw-text-red-800"
                          data-action="click->mistake-heatmap#removePartialRange">
                    Remove
                  </button>
                  <input type="hidden" 
                         name="mistakes[<%= word_id %>_<%= mistake.char_start %>_<%= mistake.char_end %>][char_start]"
                         value="<%= mistake.char_start %>">
                  <input type="hidden" 
                         name="mistakes[<%= word_id %>_<%= mistake.char_start %>_<%= mistake.char_end %>][char_end]"
                         value="<%= mistake.char_end %>">
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div>
      <h2 class="tw-text-xl tw-font-semibold tw-mb-4">Page Preview</h2>
      <div id="preview" class="tw-border tw-border-gray-300 tw-rounded tw-p-4 tw-bg-white" style="direction: rtl;">
        <%= render 'page_preview' %>
      </div>
    </div>
  </div>

  <div class="tw-mt-8 tw-pt-6 tw-border-t tw-border-gray-300 tw-flex tw-items-center tw-justify-between">
    <div>
      <%= link_to "View Heatmap", mistake_heatmap_path(page: page_number), class: "tw-px-6 tw-py-2 tw-bg-green-500 tw-text-white tw-rounded hover:tw-bg-green-600" %>
    </div>
    <div class="tw-text-sm tw-text-gray-600">
      Changes are saved automatically
    </div>
  </div>
<% end %>

<script>
  let selectedChars = {};

  function togglePartialRangeSelector(wordId, wordText) {
    const selector = document.getElementById(`partial-range-selector-${wordId}`);
    if (selector.classList.contains('tw-hidden')) {
      selector.classList.remove('tw-hidden');
      selectedChars[wordId] = new Set();
      updateRangeDisplay(wordId);
      resetCharButtons(wordId);
    } else {
      selector.classList.add('tw-hidden');
      selectedChars[wordId] = new Set();
    }
  }

  function resetCharButtons(wordId) {
    document.querySelectorAll(`[data-word-id="${wordId}"].partial-range-char`).forEach(btn => {
      btn.classList.remove('tw-bg-blue-300', 'tw-border-blue-500');
      btn.dataset.selected = 'false';
    });
  }

  function toggleCharSelection(button, wordId) {
    const charIndex = parseInt(button.dataset.charIndex);
    const isSelected = button.dataset.selected === 'true';
    
    if (!selectedChars[wordId]) {
      selectedChars[wordId] = new Set();
    }
    
    if (isSelected) {
      selectedChars[wordId].delete(charIndex);
      button.classList.remove('tw-bg-blue-300', 'tw-border-blue-500');
      button.dataset.selected = 'false';
    } else {
      selectedChars[wordId].add(charIndex);
      button.classList.add('tw-bg-blue-300', 'tw-border-blue-500');
      button.dataset.selected = 'true';
    }
    
    updateRangeDisplay(wordId);
  }

  function updateRangeDisplay(wordId) {
    const selected = selectedChars[wordId] || new Set();
    const display = document.getElementById(`selected-range-${wordId}`);
    
    if (selected.size === 0) {
      display.textContent = '-';
      return;
    }
    
    const sorted = Array.from(selected).sort((a, b) => a - b);
    const min = Math.min(...sorted);
    const max = Math.max(...sorted);
    
    display.textContent = `Chars ${min} to ${max} (${selected.size} selected)`;
  }

  function confirmPartialRange(wordId, wordText) {
    const selected = selectedChars[wordId] || new Set();
    
    if (selected.size === 0) {
      alert('Please select at least one character');
      return;
    }

    const sorted = Array.from(selected).sort((a, b) => a - b);
    const start = Math.min(...sorted);
    const end = Math.max(...sorted) + 1;

    const container = document.getElementById(`partial-mistakes-${wordId}`);
    const rangeKey = `${start}-${end}`;
    const existingRange = container.querySelector(`[data-partial-range="${rangeKey}"]`);
    
    if (existingRange) {
      alert('This range already exists.');
      return;
    }
    
    const partialDiv = document.createElement('div');
    partialDiv.className = 'tw-flex tw-gap-2 tw-items-center tw-bg-blue-50 tw-p-2 tw-rounded';
    partialDiv.setAttribute('data-partial-range', rangeKey);
    
    partialDiv.innerHTML = `
      <span class="tw-text-sm">Chars ${start}-${end - 1}:</span>
      <input type="number" 
             step="0.01"
             name="mistakes[${wordId}_${start}_${end}][frequency]"
             value="0"
             min="0"
             max="1"
             class="tw-flex-1 tw-border tw-border-gray-300 tw-rounded tw-px-2 tw-py-1 partial-mistake-input"
             data-listener-attached="false">
      <button type="button" 
              class="tw-text-red-600 hover:tw-text-red-800"
              data-action="click->mistake-heatmap#removePartialRange">
        Remove
      </button>
      <input type="hidden" 
             name="mistakes[${wordId}_${start}_${end}][char_start]"
             value="${start}">
      <input type="hidden" 
             name="mistakes[${wordId}_${start}_${end}][char_end]"
             value="${end}">
    `;
    
    container.appendChild(partialDiv);
    
    setTimeout(() => {
      const formElement = document.querySelector('[data-controller*="mistake-heatmap"]')
      if (formElement) {
        const app = window.Stimulus?.application || document.documentElement.stimulus
        if (app) {
          try {
            const controller = app.getControllerForElementAndIdentifier(formElement, 'mistake-heatmap')
            if (controller && controller.attachListenersToNewInputs) {
              controller.attachListenersToNewInputs()
            }
          } catch (e) {
            console.log('Could not get controller, inputs will be attached via MutationObserver')
          }
        }
      }
    }, 200)
    
    cancelPartialRange(wordId);
  }

  function cancelPartialRange(wordId) {
    const selector = document.getElementById(`partial-range-selector-${wordId}`);
    selector.classList.add('tw-hidden');
    selectedChars[wordId] = new Set();
    resetCharButtons(wordId);
    updateRangeDisplay(wordId);
  }
  
  function removePartialRange(button) {
    button.closest('[data-partial-range]').remove();
  }
</script>
