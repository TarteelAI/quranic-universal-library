<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayah Timeline V2 - Silence-based Adjustments</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            margin-bottom: 40px;
            opacity: 0.8;
            font-size: 1.1em;
        }

        .timeline-section {
            margin: 40px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
        }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #ffd700;
            font-weight: bold;
        }

        .timeline-wrapper {
            position: relative;
            overflow-x: auto;
            overflow-y: hidden;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 0;
        }

        .timeline {
            position: relative;
            height: 80px;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: visible;
            min-width: 100%;
        }

        .zoom-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            align-items: center;
        }

        .zoom-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .zoom-info {
            color: #ffd700;
            font-weight: bold;
            margin: 0 10px;
        }

        .ayah-bar {
            position: absolute;
            height: 30px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .ayah-bar.original {
            top: 5px;
            opacity: 0.4;
            border-style: dashed;
        }

        .ayah-bar.corrected {
            top: 45px;
            opacity: 1;
        }

        .ayah-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            opacity: 1;
        }

        .silence-bar {
            position: absolute;
            height: 8px;
            top: 36px;
            background: rgba(255, 0, 0, 0.5);
            border: 1px solid rgba(255, 0, 0, 0.8);
            border-radius: 2px;
            cursor: pointer;
            z-index: 10;
        }

        .silence-bar:hover {
            background: rgba(255, 0, 0, 0.8);
        }

        .gap-indicator {
            position: absolute;
            height: 12px;
            top: 34px;
            background: rgba(255, 255, 0, 0.3);
            border: 1px dashed rgba(255, 255, 0, 0.6);
            border-radius: 2px;
            pointer-events: none;
        }

        .ayah-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .ayah-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .ayah-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .ayah-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .ayah-5 { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .ayah-6 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .ayah-7 { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 25px;
            backdrop-filter: blur(5px);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .info-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .info-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .time-axis {
            position: relative;
            height: 30px;
            margin: 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .time-marker {
            position: absolute;
            font-size: 10px;
            opacity: 0.7;
            top: 5px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-label {
            opacity: 0.8;
            margin-top: 5px;
            font-size: 0.9em;
        }

        .comparison-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comparison-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            color: #ffd700;
        }

        .comparison-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .adjustment-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            background: rgba(100, 200, 100, 0.3);
            border: 1px solid rgba(100, 200, 100, 0.6);
        }

        .positive-change {
            color: #4ade80;
        }

        .negative-change {
            color: #f87171;
        }

        .audio-drop-zone {
            border: 3px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .audio-drop-zone:hover,
        .audio-drop-zone.drag-over {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .audio-drop-zone.has-audio {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }

        .audio-drop-zone .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .audio-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .play-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .play-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .play-btn.playing {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        }

        .audio-info {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Ayah Timeline V2</h1>
    <p class="subtitle">Silence-based Boundary Adjustments | Strategy: Extend End Times, Preserve Start Times | Min Gap: 100ms | Audio Playback Enabled</p>

    <div class="stats" id="statsContainer"></div>

    <div id="audioDropZone" class="audio-drop-zone">
        <div class="icon">🎵</div>
        <h3>Drop Audio File Here</h3>
        <p>Or click to browse</p>
        <div id="audioFileName" class="audio-info"></div>
        <input type="file" id="audioFileInput" accept="audio/*" style="display: none;">
        <div style="font-size: 0.85em; opacity: 0.6; margin-top: 10px;">
            💡 Tip: Use Space/Esc to stop playback | +/- to zoom | 0 to reset
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(255, 255, 255, 0.4); border-style: dashed;"></div>
            <span>Original Timing</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
            <span>Corrected Timing</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(255, 0, 0, 0.5);"></div>
            <span>Silence Detection</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(255, 255, 0, 0.3);"></div>
            <span>Gap</span>
        </div>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomOut()">🔍-</button>
        <button class="zoom-btn" onclick="resetZoom()">Reset</button>
        <button class="zoom-btn" onclick="zoomIn()">🔍+</button>
        <span class="zoom-info" id="zoomLevel">Zoom: 1x</span>
    </div>

    <div class="timeline-section">
        <div class="section-title">Visual Timeline</div>
        <div class="timeline-wrapper">
            <div id="timeline" class="timeline"></div>
            <div class="time-axis" id="timeAxis"></div>
        </div>
    </div>

    <div id="infoPanel" class="info-panel">
        <h3 id="infoTitle">Click on any ayah or silence to see details</h3>
        <div id="infoContent"></div>
    </div>

    <div class="timeline-section">
        <div class="section-title">Detailed Comparison Table</div>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="comparisonTable">
                <thead>
                    <tr>
                        <th>Ayah</th>
                        <th>Original Start</th>
                        <th>Corrected Start</th>
                        <th>Start Δ</th>
                        <th>Original End</th>
                        <th>Corrected End</th>
                        <th>End Δ</th>
                        <th>Duration</th>
                        <th>Gap to Next</th>
                        <th>Method</th>
                        <th>Play</th>
                    </tr>
                </thead>
                <tbody id="comparisonBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
  let data = [];
  let currentZoom = 1;
  const minZoom = 0.5;
  const maxZoom = 200;
  let audioElement = null;
  let audioLoaded = false;
  let currentlyPlaying = null;

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  // Initialize audio handling
  function initAudioHandling() {
    const dropZone = document.getElementById('audioDropZone');
    const fileInput = document.getElementById('audioFileInput');
    const audioFileName = document.getElementById('audioFileName');

    // Click to browse
    dropZone.addEventListener('click', (e) => {
      if (e.target !== fileInput) {
        fileInput.click();
      }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleAudioFile(e.target.files[0]);
      }
    });

    // Drag and drop handlers
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      
      if (e.dataTransfer.files.length > 0) {
        handleAudioFile(e.dataTransfer.files[0]);
      }
    });
  }

  function handleAudioFile(file) {
    const dropZone = document.getElementById('audioDropZone');
    const audioFileName = document.getElementById('audioFileName');
    
    if (!file.type.startsWith('audio/')) {
      alert('Please select an audio file');
      return;
    }

    const url = URL.createObjectURL(file);
    
    if (audioElement) {
      audioElement.pause();
      audioElement = null;
    }

    audioElement = new Audio(url);
    audioElement.addEventListener('loadedmetadata', () => {
      audioLoaded = true;
      dropZone.classList.add('has-audio');
      audioFileName.innerHTML = `
        ✓ Loaded: <strong>${escapeHtml(file.name)}</strong> (${formatTime(audioElement.duration * 1000)})
      `;
    });

    audioElement.addEventListener('ended', () => {
      if (currentlyPlaying) {
        const btn = document.getElementById(currentlyPlaying);
        if (btn) {
          btn.textContent = btn.textContent.replace('⏸', '▶️');
          btn.classList.remove('playing');
        }
        currentlyPlaying = null;
      }
    });
  }

  function playAudioSegment(startMs, endMs, buttonId) {
    if (!audioLoaded || !audioElement) {
      alert('Please load an audio file first');
      return;
    }

    const btn = document.getElementById(buttonId);
    
    // If currently playing this segment, pause it
    if (currentlyPlaying === buttonId) {
      audioElement.pause();
      btn.textContent = btn.textContent.replace('⏸', '▶️');
      btn.classList.remove('playing');
      currentlyPlaying = null;
      return;
    }

    // Stop any other playing segment
    if (currentlyPlaying) {
      const prevBtn = document.getElementById(currentlyPlaying);
      if (prevBtn) {
        prevBtn.textContent = prevBtn.textContent.replace('⏸', '▶️');
        prevBtn.classList.remove('playing');
      }
    }

    // Play the new segment
    audioElement.currentTime = startMs / 1000;
    audioElement.play();
    
    btn.textContent = btn.textContent.replace('▶️', '⏸');
    btn.classList.add('playing');
    currentlyPlaying = buttonId;

    // Stop at end time
    const checkTime = setInterval(() => {
      if (audioElement.currentTime >= endMs / 1000) {
        audioElement.pause();
        btn.textContent = btn.textContent.replace('⏸', '▶️');
        btn.classList.remove('playing');
        currentlyPlaying = null;
        clearInterval(checkTime);
      }
    }, 50);
  }

  const urlParams = new URLSearchParams(window.location.search);
  const surahNumber = urlParams.get("surah");
  const reciter = urlParams.get("reciter");

  if (!surahNumber || !reciter) {
    document.body.innerHTML = "<div class='container'><h2>⚠️ Please provide surah number (?surah=1) and reciter (?reciter=1)</h2></div>";
  } else {
    initAudioHandling();
    let dataPath = `./waveform-ayah-segments/result/${reciter}_v2_plot_data/${surahNumber}.json`;

    fetch(dataPath)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(loadedData => {
        data = loadedData;
        document.querySelector('h1').textContent = `Surah ${surahNumber} - Ayah Timeline V2`;
        createTimeline();
        createComparisonTable();
        updateStats();
      })
      .catch(error => {
        console.error('Error loading data:', error);
        document.body.innerHTML = `
          <div class='container'>
            <h2>❌ Error loading data</h2>
            <p>Could not load: ${escapeHtml(dataPath)}</p>
            <p>Error: ${escapeHtml(error.message)}</p>
            <p>Make sure you've run adjust_ayah_boundaries_with_silences() method first.</p>
          </div>
        `;
      });
  }

  function formatTime(ms) {
    const seconds = ms / 1000;
    if (seconds >= 60) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = (seconds % 60).toFixed(1);
      return `${minutes}m ${remainingSeconds}s`;
    }
    return seconds.toFixed(1) + 's';
  }

  function zoomIn() {
    if (currentZoom < maxZoom) {
      currentZoom *= 1.5;
      updateZoom();
    }
  }

  function zoomOut() {
    if (currentZoom > minZoom) {
      currentZoom /= 1.5;
      updateZoom();
    }
  }

  function resetZoom() {
    currentZoom = 1;
    updateZoom();
  }

  function updateZoom() {
    const timeline = document.getElementById('timeline');
    const timeAxis = document.getElementById('timeAxis');

    timeline.style.width = (100 * currentZoom) + '%';
    timeAxis.style.width = (100 * currentZoom) + '%';

    document.getElementById('zoomLevel').textContent = `Zoom: ${currentZoom.toFixed(1)}x`;

    createTimeline();
  }

  function createTimeline() {
    if (!data || data.length === 0) return;

    const timeline = document.getElementById('timeline');
    const timeAxis = document.getElementById('timeAxis');

    timeline.innerHTML = '';
    timeAxis.innerHTML = '';

    const maxTime = Math.max(...data.map(d => Math.max(d.end_time, d.corrected_end_time || d.end_time)));

    // Create time markers
    const markerInterval = getOptimalMarkerInterval(maxTime, currentZoom);
    for (let time = 0; time <= maxTime; time += markerInterval) {
      const position = (time / maxTime) * 100;

      const marker = document.createElement('div');
      marker.className = 'time-marker';
      marker.style.left = position + '%';
      marker.textContent = formatTime(time);
      timeAxis.appendChild(marker);
    }

    // Create ayah bars and silences
    data.forEach((ayah, index) => {
      // Original ayah bar (dashed, top)
      const originalBar = document.createElement('div');
      originalBar.className = `ayah-bar original ayah-${(ayah.ayah % 7) + 1}`;
      originalBar.style.left = (ayah.start_time / maxTime) * 100 + '%';
      originalBar.style.width = ((ayah.end_time - ayah.start_time) / maxTime) * 100 + '%';
      
      const originalWidth = ((ayah.end_time - ayah.start_time) / maxTime) * 100 * currentZoom;
      if (originalWidth > 8) {
        originalBar.textContent = `A${ayah.ayah} (orig)`;
      } else if (originalWidth > 4) {
        originalBar.textContent = `${ayah.ayah}`;
      }

      originalBar.onclick = () => showInfo('original', ayah);
      timeline.appendChild(originalBar);

      // Corrected ayah bar (solid, bottom)
      const correctedBar = document.createElement('div');
      correctedBar.className = `ayah-bar corrected ayah-${(ayah.ayah % 7) + 1}`;
      correctedBar.style.left = (ayah.corrected_start_time / maxTime) * 100 + '%';
      correctedBar.style.width = ((ayah.corrected_end_time - ayah.corrected_start_time) / maxTime) * 100 + '%';
      
      const correctedWidth = ((ayah.corrected_end_time - ayah.corrected_start_time) / maxTime) * 100 * currentZoom;
      if (correctedWidth > 8) {
        correctedBar.textContent = `Ayah ${ayah.ayah}`;
      } else if (correctedWidth > 4) {
        correctedBar.textContent = `${ayah.ayah}`;
      }

      correctedBar.onclick = () => showInfo('corrected', ayah);
      timeline.appendChild(correctedBar);

      // Silence bar if exists
      if (ayah.silence_used) {
        const silenceBar = document.createElement('div');
        silenceBar.className = 'silence-bar';
        silenceBar.style.left = (ayah.silence_used.start_time / maxTime) * 100 + '%';
        silenceBar.style.width = ((ayah.silence_used.end_time - ayah.silence_used.start_time) / maxTime) * 100 + '%';
        
        silenceBar.onclick = () => showInfo('silence', ayah);
        timeline.appendChild(silenceBar);
      }

      // Gap indicator to next ayah
      if (index < data.length - 1) {
        const nextAyah = data[index + 1];
        const gapStart = ayah.corrected_end_time;
        const gapEnd = nextAyah.corrected_start_time;
        
        if (gapEnd > gapStart) {
          const gapBar = document.createElement('div');
          gapBar.className = 'gap-indicator';
          gapBar.style.left = (gapStart / maxTime) * 100 + '%';
          gapBar.style.width = ((gapEnd - gapStart) / maxTime) * 100 + '%';
          timeline.appendChild(gapBar);
        }
      }
    });
  }

  function getOptimalMarkerInterval(maxTime, zoom) {
    const baseIntervals = [1000, 2000, 5000, 10000, 15000, 30000, 60000, 120000, 300000];
    const targetMarkers = Math.max(5, Math.min(20, 10 * zoom));

    for (let interval of baseIntervals) {
      if (maxTime / interval <= targetMarkers) {
        return interval;
      }
    }
    return baseIntervals[baseIntervals.length - 1];
  }

  function showInfo(type, ayah) {
    const infoPanel = document.getElementById('infoPanel');
    const infoTitle = document.getElementById('infoTitle');
    const infoContent = document.getElementById('infoContent');

    if (type === 'original') {
      const duration = ayah.end_time - ayah.start_time;
      infoTitle.textContent = `Ayah ${ayah.ayah} - Original Timing`;
      infoContent.innerHTML = `
        <p><strong>Start Time:</strong> ${formatTime(ayah.start_time)} (${ayah.start_time}ms)</p>
        <p><strong>End Time:</strong> ${formatTime(ayah.end_time)} (${ayah.end_time}ms)</p>
        <p><strong>Duration:</strong> ${formatTime(duration)} (${duration}ms)</p>
        <div class="audio-controls">
          <button id="playOriginal${ayah.ayah}" class="play-btn" onclick="playAudioSegment(${ayah.start_time}, ${ayah.end_time}, 'playOriginal${ayah.ayah}')">
            ▶️ Play Original
          </button>
        </div>
      `;
    } else if (type === 'corrected') {
      const duration = ayah.corrected_end_time - ayah.corrected_start_time;
      const startAdjustment = ayah.corrected_start_time - ayah.start_time;
      const endAdjustment = ayah.corrected_end_time - ayah.end_time;
      
      infoTitle.textContent = `Ayah ${ayah.ayah} - Corrected Timing`;
      infoContent.innerHTML = `
        <p><strong>Orgional time:</strong> ${formatTime(ayah.start_time)}(${ayah.start_time}ms) - (${formatTime(ayah.end_time)}(${ayah.end_time})ms)</p>

        <p><strong>Corrected Start:</strong> ${formatTime(ayah.corrected_start_time)} (${ayah.corrected_start_time}ms)</p>
        <p><strong>Start Adjustment:</strong> <span class="${startAdjustment < 0 ? 'negative-change' : 'positive-change'}">${startAdjustment > 0 ? '+' : ''}${startAdjustment}ms</span></p>
        <p><strong>Corrected End:</strong> ${formatTime(ayah.corrected_end_time)} (${ayah.corrected_end_time}ms)</p>
        <p><strong>End Adjustment:</strong> <span class="${endAdjustment < 0 ? 'negative-change' : 'positive-change'}">${endAdjustment > 0 ? '+' : ''}${endAdjustment}ms</span></p>
        <p><strong>Duration:</strong> ${formatTime(duration)} (${duration}ms)</p>
        <p><strong>Method:</strong> <span class="adjustment-badge">${ayah.adjustment_method || 'N/A'}</span></p>
        <div class="audio-controls">
          <button id="playCorrected${ayah.ayah}" class="play-btn" onclick="playAudioSegment(${ayah.corrected_start_time}, ${ayah.corrected_end_time}, 'playCorrected${ayah.ayah}')">
            ▶️ Play Corrected
          </button>
          <button id="playOriginalComp${ayah.ayah}" class="play-btn" onclick="playAudioSegment(${ayah.start_time}, ${ayah.end_time}, 'playOriginalComp${ayah.ayah}')" style="opacity: 0.7;">
            ▶️ Play Original (Compare)
          </button>
        </div>
      `;
    } else if (type === 'silence') {
      const silence = ayah.silence_used;
      infoTitle.textContent = `Silence before Ayah ${ayah.ayah}`;
      infoContent.innerHTML = `
        <p><strong>Silence Start:</strong> ${formatTime(silence.start_time)} (${silence.start_time}ms)</p>
        <p><strong>Silence End:</strong> ${formatTime(silence.end_time)} (${silence.end_time}ms)</p>
        <p><strong>Duration:</strong> ${formatTime(silence.duration)} (${silence.duration}ms)</p>
        <p><strong>Used for:</strong> Ayah ${ayah.ayah} boundary adjustment</p>
        <div class="audio-controls">
          <button id="playSilence${ayah.ayah}" class="play-btn" onclick="playAudioSegment(${silence.start_time}, ${silence.end_time}, 'playSilence${ayah.ayah}')">
            ▶️ Play Silence
          </button>
        </div>
      `;
    }

    infoPanel.classList.add('active');
  }

  function createComparisonTable() {
    const tbody = document.getElementById('comparisonBody');
    tbody.innerHTML = '';

    data.forEach((ayah, index) => {
      const row = document.createElement('tr');
      const startAdjustment = ayah.corrected_start_time - ayah.start_time;
      const endAdjustment = ayah.corrected_end_time - ayah.end_time;
      const correctedDuration = ayah.corrected_end_time - ayah.corrected_start_time;

      const gapToNext = ayah.gap_to_next !== null && ayah.gap_to_next !== undefined
        ? `${ayah.gap_to_next}ms`
        : '-';

      // Highlight gaps that are less than 100ms in red
      const gapClass = ayah.gap_to_next !== null && ayah.gap_to_next < 100 
        ? 'negative-change' 
        : '';

      row.innerHTML = `
        <td><strong>Ayah ${ayah.ayah}</strong></td>
        <td>${formatTime(ayah.start_time)}</td>
        <td>${formatTime(ayah.corrected_start_time)}</td>
        <td class="${startAdjustment < 0 ? 'negative-change' : 'positive-change'}">${startAdjustment > 0 ? '+' : ''}${startAdjustment}ms</td>
        <td>${formatTime(ayah.end_time)}</td>
        <td>${formatTime(ayah.corrected_end_time)}</td>
        <td class="${endAdjustment < 0 ? 'negative-change' : 'positive-change'}">${endAdjustment > 0 ? '+' : ''}${endAdjustment}ms</td>
        <td>${formatTime(correctedDuration)}</td>
        <td class="${gapClass}"><strong>${gapToNext}</strong></td>
        <td><span class="adjustment-badge">${ayah.adjustment_method || 'N/A'}</span></td>
        <td>
          <button id="playTableCorrected${ayah.ayah}" class="play-btn" onclick="playAudioSegment(${ayah.corrected_start_time}, ${ayah.corrected_end_time}, 'playTableCorrected${ayah.ayah}')" style="padding: 5px 10px; font-size: 0.9em;">
            ▶️
          </button>
        </td>
      `;
      
      tbody.appendChild(row);
    });
  }

  function updateStats() {
    if (!data || data.length === 0) return;

    const maxTime = Math.max(...data.map(d => d.corrected_end_time));
    const totalOriginalTime = data.reduce((sum, ayah) => sum + (ayah.end_time - ayah.start_time), 0);
    const totalCorrectedTime = data.reduce((sum, ayah) => sum + (ayah.corrected_end_time - ayah.corrected_start_time), 0);
    
    // Calculate gap statistics
    const gaps = [];
    data.slice(0, -1).forEach((ayah, index) => {
      const nextAyah = data[index + 1];
      const gap = nextAyah.corrected_start_time - ayah.corrected_end_time;
      if (gap > 0) gaps.push(gap);
    });
    
    const totalGaps = gaps.reduce((sum, gap) => sum + gap, 0);
    const avgGap = gaps.length > 0 ? totalGaps / gaps.length : 0;
    const minGap = gaps.length > 0 ? Math.min(...gaps) : 0;
    const maxGap = gaps.length > 0 ? Math.max(...gaps) : 0;

    const silencesUsed = data.filter(ayah => ayah.silence_used).length;
    const avgStartAdjustment = data.reduce((sum, ayah) => sum + Math.abs(ayah.corrected_start_time - ayah.start_time), 0) / data.length;
    const maxStartAdjustment = Math.max(...data.map(ayah => Math.abs(ayah.corrected_start_time - ayah.start_time)));
    
    const avgEndAdjustment = data.reduce((sum, ayah) => sum + Math.abs(ayah.corrected_end_time - ayah.end_time), 0) / data.length;

    const statsContainer = document.getElementById('statsContainer');
    statsContainer.innerHTML = `
      <div class="stat-card">
        <div class="stat-value">${data.length}</div>
        <div class="stat-label">Total Ayahs</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${formatTime(maxTime)}</div>
        <div class="stat-label">Total Duration</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${silencesUsed}/${data.length}</div>
        <div class="stat-label">Silences Used</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${Math.round(avgGap)}ms</div>
        <div class="stat-label">Avg Gap</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color: ${minGap < 100 ? '#f87171' : '#4ade80'}">${Math.round(minGap)}ms</div>
        <div class="stat-label">Min Gap</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${Math.round(maxGap)}ms</div>
        <div class="stat-label">Max Gap</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${Math.round(avgStartAdjustment)}ms</div>
        <div class="stat-label">Avg Start Δ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${Math.round(avgEndAdjustment)}ms</div>
        <div class="stat-label">Avg End Δ</div>
      </div>
    `;
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    if (e.key === '+' || e.key === '=') {
      e.preventDefault();
      zoomIn();
    } else if (e.key === '-') {
      e.preventDefault();
      zoomOut();
    } else if (e.key === '0') {
      e.preventDefault();
      resetZoom();
    } else if (e.key === ' ' || e.key === 'Escape') {
      e.preventDefault();
      // Stop audio playback
      if (audioElement && currentlyPlaying) {
        audioElement.pause();
        const btn = document.getElementById(currentlyPlaying);
        if (btn) {
          btn.textContent = btn.textContent.replace('⏸', '▶️');
          btn.classList.remove('playing');
        }
        currentlyPlaying = null;
      }
    }
  });

  // Add keyboard shortcuts info
  console.log(`
    Keyboard Shortcuts:
    + or = : Zoom In
    - : Zoom Out
    0 : Reset Zoom
    Space or Escape : Stop Audio Playback
  `);
</script>
</body>
</html>


